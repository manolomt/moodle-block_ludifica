define(["jquery","core/notification","core/str","core/ajax","block_ludifica/alertc","block_ludifica/player","core/modal_factory"],function(e,t,c,i,o,n,a){M.cfg.wwwroot;var l=[],d=null;function s(c){var n=e("<div></div>"),a=e('<select id="block_ludifica_ticket_given_contact" class="form-control"></select>');n.append("<h4>"+l.giveticketmessage+"</h4>"),d.forEach(e=>{a.append('<option value="'+e.id+'">'+e.name+"</option>")}),n.append(a),t.confirm(l.giveticket,n.html(),l.give,l.cancel,function(){var t=parseInt(e("#block_ludifica_ticket_given_contact").val());i.call([{methodname:"block_ludifica_give_ticket",args:{ticketid:c,contactid:t},done:function(e){e?(o.success(l.given),u(c)):o.error(l.notgive)},fail:function(e){o.error(e.message),console.log(e)}}])})}function u(t){i.call([{methodname:"block_ludifica_get_ticket",args:{id:t},done:function(c){if(c&&"object"==typeof c){var i=e("#ticket-"+t),o=e("#moreinfo-ticket-content-"+t+" .usertickets"),n=o.find("ul"),a=0;i.find('val[key="available"]').html(c.available),i.find('val[key="usertickets"]').html(c.usertickets.length),n.empty(),c.usertickets.length>0?(i.find('[data-action="give"]').show(),o.show(),c.usertickets.forEach(t=>{var c=e('<li class="list-group-item"></li>'),i=e('<span class="usercode">'+t.usercode+" </span>");if(c.append(i),t.timeused){i.addClass("usercode-used");var o=l.usedat.replace("USERDATE",t.timeusedformatted),d=e("<em> "+o+"</em>");c.append(d)}n.append(c),t.timeused||a++})):o.hide(),0==a&&i.find('[data-action="give"]').hide(),c.available<=0||c.byuser<=c.usertickets.length?i.find('[data-action="buy"]').hide():i.find('[data-action="buy"]').show()}},fail:function(e){console.log(e)}}])}return{init:function(r){var f=[{key:"buyticket",component:"block_ludifica"},{key:"buyticketmessage",component:"block_ludifica"},{key:"buy",component:"block_ludifica"},{key:"notbuy",component:"block_ludifica"},{key:"give",component:"block_ludifica"},{key:"given",component:"block_ludifica"},{key:"notgive",component:"block_ludifica"},{key:"giveticket",component:"block_ludifica"},{key:"giveticketmessage",component:"block_ludifica"},{key:"notcontacts",component:"block_ludifica"},{key:"bought",component:"block_ludifica"},{key:"usedat",component:"block_ludifica",param:"USERDATE"},{key:"cancel"},{key:"continue"},{key:"error"},{key:"info"}];f.forEach(function(e,t){l[e.key]=e.key}),c.get_strings(f).then(function(e){e.forEach(function(e,t){l[f[t].key]=e})}),e('[data-action="buy"]').on("click",function(){var c=e(this).data("id");t.confirm(l.buyticket,l.buyticketmessage,l.buy,l.cancel,function(){i.call([{methodname:"block_ludifica_buy_ticket",args:{id:c},done:function(e){e?(o.success(l.bought),u(c),n.reloadStats()):o.error(l.notbuy)},fail:function(e){console.log("Error buy ticket"),console.log(e)}}])})}),e('[data-action="give"]').on("click",function(){var t=e(this).data("id");d?s(t):i.call([{methodname:"core_message_get_user_contacts",args:{userid:r},done:function(e){e&&"object"==typeof e&&e.length>0?(d=[],e.forEach(e=>{e.isdeleted||e.isblocked||!e.iscontact||d.push({name:e.fullname,id:e.id})}),s(t)):o.warning(l.notcontacts)},fail:function(e){o.error(e.message),console.log(e)}}])}),e('[data-action="showmore"]').on("click",function(){var t=e(this).data("id"),c=e("#moreinfo-ticket-"+t),i={title:c.attr("title"),body:c.html()};a.create(i).then(function(e){e.show()})})}}});